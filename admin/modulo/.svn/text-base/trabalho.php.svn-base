<?php
/**
 * @abstract Mdulo referente as aes do desenvolvimento do sistema
 * 
 * @copyright  -
 * @version    1.0
 * @author     Alexandre
 * @since      10/03/2009
 */
class Modulo_Trabalho extends Sistema_Modulo{
	
	protected $_modulo = "trabalho";

	/**
	 * Ao responsvel pela criao do formulrio
	 * para cadastros dos Mdulos
	 * @return Form
	 */
	public function acaoFormtrabalho(){
		$mapa = new Classe_Trabalho($_GET['trb_cod']);
		$form = new Componente_Formulario($mapa);
		
		$this->_layout->setBotoes("Listar Trabalhos",Sistema_Util::getURL($this->_modulo,"listartrabalho"),"imagens/list.png");
		$this->_layout->setNomePagina("Gerenciar Trabalho");
		$this->_layout->setCorpo($form->getForm($this->_modulo,"salvartrabalho"));
	}

	/**
	 * Ao responsvel pela criao da listagem
	 * dos Mdulos
	 * @return Listagem
	 */
	public function acaoListartrabalho()
	{
		$sql = "
		SELECT 
			trb_cod, 
			trb_titulo, 
			usr_nome,
			trb_categoria,
			stt_nome
		FROM trabalho 
			INNER JOIN usuario ON
				usuario.usr_cod = trabalho.usr_cod
			INNER JOIN status ON
				status.stt_cod = trabalho.trb_status";
		
		$lista = new Componente_Listagem('listartrabalho');
		$lista->setSQL($sql);

		$lista->setColuna("trb_cod","Cdigo","5%");
		$lista->setColuna("usr_nome","Nome Participante");
		$lista->setColuna("trb_titulo","Titulo Trabalho");
		$lista->setColuna("trb_categoria","Categoria");
		$lista->setColuna("stt_nome","Status");
		
		$lista->setNomeParametro("trb_cod");
		
		$lista->setBotaoModuloAcao("Gerenciar",$this->_modulo,"Formtrabalho",Componente_Listagem::$_IMG_ALTERAR);

		$this->_layout->setNomePagina("Listagem de Trabalhos Submetidos");
		$this->_layout->setCorpo($lista->getForm());
	}

	/**
	 * Ao responsvel para salvar os dados vindos
	 * do formulrio
	 * @return JSON
	 */
	public function ajaxSalvartrabalho(){
		$obj = new Classe_Trabalho();
		$obj->setDados($_POST);
		$id = $obj->salvar();
		$json = new Sistema_Ajax();
		$json->addVar($id);
		$json->responde();
	}
	
	/**
	 * Ao responsvel pela criao do formulrio
	 * para cadastros das Aes
	 * @return Form
	 */
	public function acaoFormAcao(){
		$mapa = new Classe_Acao($_GET['acao_cod']);
		$form = new Componente_Formulario($mapa);
		
		$this->_layout->setBotoes("Nova Ao",Sistema_Util::getURL($this->_modulo,"formacao"),"imagens/form.png");
		$this->_layout->setBotoes("Listar Aes",Sistema_Util::getURL($this->_modulo,"listaracao"),"imagens/list.png");		
		
		$this->_layout->setNomePagina("Cadastrar Aes");
		$this->_layout->setCorpo($form->getForm($this->_modulo,"salvaracao"));
	}

	/**
	 * Ao responsvel para salvar os dados vindos
	 * do formulrio
	 * @return JSON
	 */	
	public function ajaxSalvarAcao(){
		$obj = new Classe_Acao();
		$obj->setDados($_POST);
		$id = $obj->salvar();
		$json = new Sistema_Ajax();
		$json->addVar($id);
		$json->responde();
	}	
	
	/**
	 * Ao responsvel pela criao da listagem
	 * das Aes
	 * @return Listagem
	 */	
	public function acaoListarAcao(){
		$lista = new Componente_Listagem('listacao');
		$sql = "SELECT acao_cod,acao_nome,acao_titulo,
					   mdl_titulo,acao_ordem 
				FROM acao 
				INNER JOIN modulo ON modulo.mdl_cod = acao.mdl_cod";
		$lista->setSQL($sql);
		$lista->setColuna("acao_cod","Cdigo","5%");
		$lista->setColuna("acao_nome","Nome");
		$lista->setColuna("acao_titulo","Titulo");
		$lista->setColuna("mdl_titulo","Mdulo");
		$lista->setColuna("acao_ordem","Ordem","10%");
		$lista->setNomeParametro("acao_cod");
		$lista->setBotaoModuloAcao("Alterar",$this->_modulo,"formacao",Componente_Listagem::$_IMG_ALTERAR);
		
		$this->_layout->setBotoes("Nova Ao",Sistema_Util::getURL($this->_modulo,"formacao"),"imagens/form.png");
		$this->_layout->setNomePagina("Listar Aes");
		$this->_layout->setCorpo($lista->getForm());
	}	
	
	/**
	 * Ao responsvel pela criao do formulrio
	 * para cadastros dos Menus
	 * @return Form
	 */
	public function acaoFormMenu(){
		$menu = new Classe_Menu($_GET['mnu_cod']);
		$form = new Componente_Formulario($menu);

		$this->_layout->setBotoes("Novo Menu",Sistema_Util::getURL($this->_modulo,"formmenu"),"imagens/form.png");
		$this->_layout->setBotoes("Listar Menus",Sistema_Util::getURL($this->_modulo,"listarmenu"),"imagens/list.png");			
		
		$this->_layout->setNomePagina("Cadastrar Menu");
		$this->_layout->setCorpo($form->getForm($this->_modulo,"salvarmenu"));
	}

	/**
	 * Ao responsvel pela criao da listagem
	 * dos menus
	 * @return Listagem
	 */	
	public function acaoListarMenu(){
		$lista = new Componente_Listagem('listmenu');
		$sql = "SELECT mnu_cod,mnu_nome FROM menu";
		$lista->setSQL($sql);
		$lista->setColuna("mnu_cod","Cdigo","5%");
		$lista->setColuna("mnu_nome","Nome");
		$lista->setNomeParametro("mnu_cod");
		$lista->setBotaoModuloAcao("Alterar",$this->_modulo,"formmenu",Componente_Listagem::$_IMG_ALTERAR);
		
		$this->_layout->setBotoes("Novo Menu",Sistema_Util::getURL($this->_modulo,"formmenu"),"imagens/form.png");
		$this->_layout->setNomePagina("Listagem de Menus");
		$this->_layout->setCorpo($lista->getForm());
	}

	/**
	 * Ao responsvel para salvar os dados vindos
	 * do formulrio
	 * @return JSON
	 */	
	public function ajaxSalvarMenu(){
		$obj = new Classe_Menu();
		$obj->setDados($_POST);
		$id = $obj->salvar();
		$json = new Sistema_Ajax();
		$json->addVar($id);
		$json->responde();
	}	

	/**
	 * Ao para testes
	 * @return String
	 */	
	public function acaoGerarmidia()
	{
		$sql = "
		SELECT
			*
		FROM trabalho t
			INNER JOIN usuario u ON
				t.usr_cod = u.usr_cod
		WHERE
			t.trb_status = ".ACEITO." OR 
			t.trb_status = ".ACEITOCOMRESALVAS;
			
		$trabalhos = Sistema_Conecta::Execute($sql);
			
		// limpar os arquivos da pasta		
		$dir_aceitos = SISTEMA_DIR."cd\\trabalhos_aceitos\\";
		$dir_enviados = UPLOAD_DIR;
		
		Modulo_Trabalho_Funcao::funlinkRecursive($dir_arquivos,false);
		
		# percorre os trabalhos que foram aceitos
		foreach($trabalhos as $trabalho)
		{
			$a  = '{"ID":"'.$trabalho['trb_cod'].'",';
			$a .= '"TITULO":"'.$trabalho['trb_titulo'].'",';
			$a .= '"AUTOR":"'.$trabalho['usr_nome'].'",';
			$a .= '"AREA":"'.$trabalho['trb_area'].'",';
			$a .= '"DESCRICAO":"'.$trabalho['trb_resumo'].'"}';
			
			$aux[] = utf8_encode(strtoupper(strtr($a,"","")));
			
			// copiar os arquivos dos trabalhos que foram aceitos para a pasta do CD
			$arquivoName = $trabalho['trb_cod'].".pdf";
			$arquivo_aceito = $dir_aceitos.$arquivoName;
			$arquivo_enviado = $dir_enviados.$arquivoName;
			copy($arquivo_enviado,$arquivo_aceito);
		}
		
		$texto = implode(",",$aux);			
		$conteudo = 'var json = ['.$texto.']; var trabalhos = new TAFFY(json);';
		
		// grava o arquivo
		$filename = SISTEMA_DIR.'cd\base.js';
		
		// Primeiro vamos ter certeza de que o arquivo existe e pode ser alterado
		if (is_writable($filename)) {
		    if (!$handle = fopen($filename, 'w')) {
		         echo "No foi possvel abrir o arquivo ($filename)";
		         exit;
		    }
		    // Escreve $conteudo no nosso arquivo aberto.
		    if (fwrite($handle, $conteudo) === FALSE) {
		        echo "No foi possvel escrever no arquivo ($filename)";
		        exit;
		    }
			$msg = Sistema_Mensagem::instanciar();
			$msg->setSucesso("Midia gerada com sucesso.");
		    fclose($handle);
		} else {
		    echo "O arquivo $filename no pode ser alterado";
		}
	}
}
?>